<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Management - GOD Services Admin</title>
    <link rel="stylesheet" href="/css/style.css">
</head>

<body>

    <!-- Navigation -->
    <nav class="navbar">
        <div class="container flex-between">
            <div class="navbar-brand">GOD SERVICES - ADMIN</div>
            <ul class="navbar-nav">
                <li><a href="/admin/dashboard.html" class="nav-link">Dashboard</a></li>
                <li><a href="/admin/workers.html" class="nav-link">Workers</a></li>
                <li><a href="/admin/customers.html" class="nav-link active">Customers</a></li>
                <li><a href="/admin/bookings.html" class="nav-link">Bookings</a></li>
                <li><a href="/admin/services.html" class="nav-link">Services</a></li>
                <li><button class="btn btn-ghost btn-sm" id="logoutBtn">Logout</button></li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container" style="padding: var(--spacing-xl) var(--spacing-md);">

        <!-- Header -->
        <section class="page-header flex-between">
            <div>
                <h1>Customer Management</h1>
                <p class="text-secondary">View and manage platform customers</p>
            </div>
        </section>

        <!-- Stats -->
        <section class="stats-section grid grid-3 gap-md mt-lg">
            <div class="stat-card">
                <div class="stat-value" id="totalCustomers">0</div>
                <div class="stat-label">Total Customers</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalCustomerBookings">0</div>
                <div class="stat-label">Total Bookings</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalSpent">â‚¹0</div>
                <div class="stat-label">Total Revenue</div>
            </div>
        </section>



        <!-- Customer List -->
        <section class="customers-list mt-md">
            <div id="customersContainer">
                <!-- Customers loaded dynamically -->
            </div>
        </section>

    </main>

    <style>
        .page-header h1 {
            font-size: 2.5rem;
            margin-bottom: var(--spacing-xs);
        }

        .filter-section {
            margin-top: var(--spacing-xxl);
        }

        .filter-section h2 {
            margin-bottom: var(--spacing-lg);
            padding-bottom: var(--spacing-sm);
            border-bottom: 2px solid var(--color-border);
        }

        .filter-bar {
            display: flex;
            gap: var(--spacing-md);
        }

        .filter-bar .form-input {
            max-width: 400px;
        }

        .customer-card {
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
            transition: all var(--transition-fast);
        }

        .customer-card:hover {
            border-color: var(--color-accent-primary);
            box-shadow: var(--shadow-md);
        }

        .customer-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: var(--spacing-md);
        }

        .customer-info h3 {
            font-size: 1.5rem;
            color: var(--color-text-primary);
            margin-bottom: var(--spacing-xs);
        }

        .customer-phone {
            font-size: 0.9rem;
            color: var(--color-accent-primary);
            letter-spacing: 0.05em;
        }

        .customer-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
            padding: var(--spacing-md) 0;
            border-top: 1px solid var(--color-border);
            border-bottom: 1px solid var(--color-border);
        }

        .detail-item {
            font-size: 0.9rem;
        }

        .detail-item strong {
            color: var(--color-text-secondary);
            display: block;
            margin-bottom: var(--spacing-xs);
        }

        .detail-item span {
            color: var(--color-text-primary);
        }

        .customer-actions {
            display: flex;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
        }

        .empty-state {
            text-align: center;
            padding: var(--spacing-xl);
            color: var(--color-text-muted);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: var(--spacing-md);
            opacity: 1;
        }

        @media (max-width: 768px) {
            .navbar-nav {
                display: none;
            }

            .customer-details {
                grid-template-columns: 1fr;
            }

            .filter-bar {
                flex-direction: column;
            }

            .filter-bar .form-input {
                max-width: 100%;
            }
        }
    </style>

    <script type="module">
        import { account, databases, APPWRITE_CONFIG, showLoading, hideLoading, showAlert, logout } from '/js/appwrite.js';
        import { Query } from 'https://cdn.jsdelivr.net/npm/appwrite@14.0.1/+esm';

        let currentUser = null;
        let allCustomers = [];
        let allBookings = [];
        let allUsers = [];

        async function init() {
            showLoading('Loading customers...');

            try {
                currentUser = await account.get();

                // Verify admin (with fallback)
                let isAdmin = false;
                try {
                    const userResponse = await databases.listDocuments(
                        APPWRITE_CONFIG.databaseId,
                        APPWRITE_CONFIG.collections.users,
                        [Query.equal('userId', currentUser.$id)]
                    );
                    isAdmin = userResponse.documents.length > 0 && userResponse.documents[0].role === 'admin';
                } catch (queryError) {
                    console.warn('userId query failed, using fallback:', queryError);
                    const allUsersRes = await databases.listDocuments(
                        APPWRITE_CONFIG.databaseId,
                        APPWRITE_CONFIG.collections.users
                    );
                    const adminUser = allUsersRes.documents.find(u => u.userId === currentUser.$id);
                    isAdmin = adminUser && adminUser.role === 'admin';
                }

                if (!isAdmin) {
                    showAlert('Unauthorized access. Admin only.', 'error');
                    setTimeout(() => { window.location.href = '/index.html'; }, 2000);
                    return;
                }

                // Load all data (each with its own error handling)
                try {
                    const customersRes = await databases.listDocuments(APPWRITE_CONFIG.databaseId, APPWRITE_CONFIG.collections.customers);
                    allCustomers = customersRes.documents;
                } catch (e) { console.warn('Could not load customers:', e); }

                try {
                    const bookingsRes = await databases.listDocuments(APPWRITE_CONFIG.databaseId, APPWRITE_CONFIG.collections.bookings);
                    allBookings = bookingsRes.documents;
                } catch (e) { console.warn('Could not load bookings:', e); }

                try {
                    const usersRes = await databases.listDocuments(APPWRITE_CONFIG.databaseId, APPWRITE_CONFIG.collections.users);
                    allUsers = usersRes.documents;
                } catch (e) { console.warn('Could not load users:', e); }

                console.log('Loaded:', allCustomers.length, 'customers,', allBookings.length, 'bookings,', allUsers.length, 'users');

                updateStats();
                displayCustomers();

            } catch (error) {
                console.error('Initialization error:', error);
                showAlert('Failed to load customers. Check console for details.', 'error');
            } finally {
                hideLoading();
            }
        }

        function updateStats() {
            // Customers = users with role 'customer'
            const customerUsers = allUsers.filter(u => u.role === 'customer');
            document.getElementById('totalCustomers').textContent = customerUsers.length;
            document.getElementById('totalCustomerBookings').textContent = allBookings.length;

            const totalRevenue = allBookings
                .filter(b => b.status === 'completed')
                .reduce((sum, b) => sum + (b.estimatedPrice || 0), 0);
            document.getElementById('totalSpent').textContent = `â‚¹${totalRevenue.toLocaleString()}`;
        }

        function displayCustomers(filter = '') {
            const container = document.getElementById('customersContainer');
            const searchTerm = filter.toLowerCase();

            // Primary source: users with role 'customer'
            let customerUsers = allUsers.filter(u => u.role === 'customer');

            if (searchTerm) {
                customerUsers = customerUsers.filter(user => {
                    const customerDoc = allCustomers.find(c => c.userId === user.userId);
                    const name = (user.name || '').toLowerCase();
                    const phone = (user.phone || '').toLowerCase();
                    const email = (user.email || '').toLowerCase();
                    const pincode = customerDoc ? (customerDoc.pincode || '').toLowerCase() : '';
                    return name.includes(searchTerm) || phone.includes(searchTerm) || email.includes(searchTerm) || pincode.includes(searchTerm);
                });
            }

            if (customerUsers.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ‘¥</div>
                        <p>${searchTerm ? 'No customers match your search' : 'No customers registered yet'}</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';

            customerUsers.forEach(user => {
                // Merge extra data from customers collection
                const customerDoc = allCustomers.find(c => c.userId === user.userId);
                const customerBookings = allBookings.filter(b => b.customerId === user.userId);
                const completedBookings = customerBookings.filter(b => b.status === 'completed');
                const totalSpent = completedBookings.reduce((sum, b) => sum + (b.estimatedPrice || 0), 0);

                const card = document.createElement('div');
                card.className = 'customer-card';
                card.innerHTML = `
                    <div class="customer-header">
                        <div class="customer-info">
                            <h3>${user.name || 'Customer'}</h3>
                            <div class="customer-phone">${user.phone || user.email || 'No contact'}</div>
                        </div>
                        <span class="badge badge-success">Active</span>
                    </div>

                    <div class="customer-details">
                        <div class="detail-item">
                            <strong>Address:</strong>
                            <span>${(customerDoc && customerDoc.address) || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Pincode:</strong>
                            <span>${(customerDoc && customerDoc.pincode) || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Joined:</strong>
                            <span>${new Date(user.createdAt || user.$createdAt).toLocaleDateString()}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Total Bookings:</strong>
                            <span>${customerBookings.length}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Completed:</strong>
                            <span>${completedBookings.length}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Total Spent:</strong>
                            <span>â‚¹${totalSpent.toLocaleString()}</span>
                        </div>
                    </div>

                    <div class="customer-actions">
                        <a href="/admin/bookings.html?customer=${user.userId}" class="btn btn-ghost btn-sm">View Bookings</a>
                    </div>
                `;

                container.appendChild(card);
            });
        }



        // Logout
        document.getElementById('logoutBtn').addEventListener('click', logout);

        init();
    </script>

    <!-- Theme Toggle -->
    <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme">
        <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2">
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
        </svg>
        <svg id="moon-icon" class="hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </svg>
    </button>

    <script type="module">
        import { toggleTheme, initTheme } from '/js/theme.js';
        window.toggleTheme = toggleTheme;
        initTheme();
    </script>

</body>

</html>
