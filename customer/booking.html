<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Service - GOD Services</title>
    <link rel="stylesheet" href="/css/style.css">
</head>

<body>

    <!-- Navigation -->
    <nav class="navbar">
        <div class="container flex-between">
            <div class="navbar-brand">GOD SERVICES</div>
            <ul class="navbar-nav">
                <li><a href="/customer/dashboard.html" class="nav-link">Dashboard</a></li>
                <li><a href="/customer/services.html" class="nav-link">Services</a></li>
                <li><a href="/customer/history.html" class="nav-link">My Bookings</a></li>
                <li><a href="/customer/profile.html" class="nav-link">Profile</a></li>
                <li><button class="btn btn-ghost btn-sm" id="logoutBtn">Logout</button></li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container" style="padding: var(--spacing-xl) var(--spacing-md); max-width: 800px;">

        <!-- Header -->
        <section class="page-header">
            <h1>Book Service</h1>
            <p class="text-secondary">Fill in the details to book your service</p>
        </section>

        <!-- Booking Form -->
        <section class="booking-form-section card mt-lg">
            <form id="bookingForm">

                <!-- Service Info -->
                <div class="form-section">
                    <h3 class="form-section-title">Service Information</h3>

                    <div class="form-group">
                        <label class="form-label">Service Category</label>
                        <input type="text" id="serviceCategory" class="form-input" readonly>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Estimated Price</label>
                        <input type="text" id="estimatedPrice" class="form-input" readonly>
                    </div>
                </div>

                <!-- Customer Details -->
                <div class="form-section">
                    <h3 class="form-section-title">Your Details</h3>

                    <div class="form-group">
                        <label class="form-label" for="customerName">Full Name</label>
                        <input type="text" id="customerName" class="form-input" placeholder="Enter your name" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="customerPhone">Phone Number</label>
                        <input type="tel" id="customerPhone" class="form-input" placeholder="+91 XXXXXXXXXX" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="customerAddress">Address</label>
                        <textarea id="customerAddress" class="form-textarea" placeholder="Enter your complete address"
                            rows="3" required></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="customerPincode">Pincode</label>
                        <input type="text" id="customerPincode" class="form-input" placeholder="e.g., 110001"
                            pattern="[0-9]{6}" required>
                    </div>
                </div>

                <!-- Problem Description -->
                <div class="form-section">
                    <h3 class="form-section-title">Problem Description</h3>

                    <div class="form-group">
                        <label class="form-label" for="problemDescription">Describe the issue</label>
                        <textarea id="problemDescription" class="form-textarea"
                            placeholder="Please describe the problem in detail..." rows="5" required></textarea>
                        <p class="form-hint">Be as specific as possible to help the worker prepare</p>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="scheduledTime">Preferred Date & Time</label>
                        <input type="datetime-local" id="scheduledTime" class="form-input" required>
                    </div>
                </div>

                <!-- Submit Button -->
                <button type="submit" class="btn btn-primary btn-block btn-lg">
                    Confirm Booking
                </button>

            </form>
        </section>

    </main>

    <style>
        .page-header h1 {
            font-size: 2.5rem;
            margin-bottom: var(--spacing-xs);
        }

        .booking-form-section {
            padding: var(--spacing-xl);
        }

        .form-section {
            margin-bottom: var(--spacing-xl);
            padding-bottom: var(--spacing-lg);
            border-bottom: 1px solid var(--color-border);
        }

        .form-section:last-of-type {
            border-bottom: none;
        }

        .form-section-title {
            font-size: 1.5rem;
            color: var(--color-accent-primary);
            margin-bottom: var(--spacing-md);
        }

        @media (max-width: 768px) {
            .navbar-nav {
                display: none;
            }

            .booking-form-section {
                padding: var(--spacing-md);
            }
        }
    </style>

    <script type="module">
        import { account, databases, APPWRITE_CONFIG, showLoading, hideLoading, showAlert, logout } from '/js/appwrite.js';
        import { Query, ID } from 'https://cdn.jsdelivr.net/npm/appwrite@14.0.1/+esm';

        let currentUser = null;
        let bookingData = {};

        // Initialize
        async function init() {
            try {
                currentUser = await account.get();

                // Get booking details from session storage
                const workerId = sessionStorage.getItem('selectedWorker');
                const category = sessionStorage.getItem('serviceCategory');
                const price = sessionStorage.getItem('estimatedPrice');

                if (!workerId || !category) {
                    showAlert('Invalid booking. Please select a worker first.', 'error');
                    setTimeout(() => {
                        window.location.href = '/customer/services.html';
                    }, 2000);
                    return;
                }

                document.getElementById('serviceCategory').value = category.replace('-', ' ').toUpperCase();
                document.getElementById('estimatedPrice').value = `â‚¹${price}/hour`;

                bookingData.workerId = workerId;
                bookingData.serviceCategory = category;
                bookingData.estimatedPrice = parseInt(price);

            } catch (error) {
                console.error('Initialization error:', error);
                showAlert('Failed to load booking form. Please try again.', 'error');
            }
        }

        // Handle form submission
        document.getElementById('bookingForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            bookingData.customerName = document.getElementById('customerName').value.trim();
            bookingData.customerPhone = document.getElementById('customerPhone').value.trim();
            bookingData.location = document.getElementById('customerAddress').value.trim();
            bookingData.pincode = document.getElementById('customerPincode').value.trim();
            bookingData.problemDescription = document.getElementById('problemDescription').value.trim();
            bookingData.scheduledTime = document.getElementById('scheduledTime').value;

            showLoading('Creating booking...');

            try {
                // Create booking directly
                await databases.createDocument(
                    APPWRITE_CONFIG.databaseId,
                    APPWRITE_CONFIG.collections.bookings,
                    ID.unique(),
                    {
                        customerId: currentUser.$id,
                        workerId: bookingData.workerId,
                        serviceCategory: bookingData.serviceCategory,
                        problemDescription: bookingData.problemDescription,
                        location: bookingData.location,
                        pincode: bookingData.pincode,
                        status: 'pending',
                        scheduledTime: bookingData.scheduledTime,
                        estimatedPrice: bookingData.estimatedPrice,
                        paymentStatus: 'pending', // Default to pending as payment is no longer handled here
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    }
                );

                showAlert('Booking created successfully! Worker will be notified.', 'success');

                // Clear session storage
                sessionStorage.removeItem('selectedWorker');
                sessionStorage.removeItem('serviceCategory');
                sessionStorage.removeItem('estimatedPrice');

                setTimeout(() => {
                    window.location.href = '/customer/dashboard.html';
                }, 2000);

            } catch (error) {
                console.error('Booking creation error:', error);
                showAlert(error.message || 'Failed to create booking. Please try again.', 'error');
            } finally {
                hideLoading();
            }
        });

        // Logout handler
        document.getElementById('logoutBtn').addEventListener('click', logout);

        // Initialize on page load
        init();
    </script>


    // Logout handler
    document.getElementById('logoutBtn').addEventListener('click', logout);

    // Initialize on page load
    init();
    </script>

</body>

</html>
