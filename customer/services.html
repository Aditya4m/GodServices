<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browse Services - GOD Services</title>
    <link rel="stylesheet" href="/css/style.css">
</head>

<body>

    <!-- Navigation -->
    <nav class="navbar">
        <div class="container flex-between">
            <div class="navbar-brand">GOD SERVICES</div>
            <ul class="navbar-nav">
                <li><a href="/customer/dashboard.html" class="nav-link">Dashboard</a></li>
                <li><a href="/customer/services.html" class="nav-link active">Services</a></li>
                <li><a href="/customer/history.html" class="nav-link">My Bookings</a></li>
                <li><a href="/customer/profile.html" class="nav-link">Profile</a></li>
                <li><button class="btn btn-ghost btn-sm" id="logoutBtn">Logout</button></li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container" style="padding: var(--spacing-xl) var(--spacing-md);">

        <!-- Header -->
        <section class="page-header">
            <h1>Available Workers</h1>
            <p class="text-secondary" id="categoryName">Browse verified service workers in your area</p>
        </section>

        <!-- Filters -->
        <section class="filters-section card mt-lg">
            <!-- Search Bar -->
            <div class="search-bar-wrapper mb-md">
                <span class="search-icon">üîç</span>
                <input type="text" id="searchInput" class="form-input search-input"
                    placeholder="Search workers by name..." autocomplete="off">
            </div>

            <div class="grid grid-3 gap-md">
                <div class="form-group">
                    <label class="form-label" for="categoryFilter">Service Category</label>
                    <select id="categoryFilter" class="form-select">
                        <option value="">All Categories</option>
                        <option value="plumber">Plumber</option>
                        <option value="electrician">Electrician</option>
                        <option value="ac-technician">AC Technician</option>
                        <option value="carpenter">Carpenter</option>
                        <option value="painter">Painter</option>
                        <option value="cleaner">Cleaner</option>
                        <option value="gardener">Gardener</option>
                        <option value="mechanic">Mechanic</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="pincodeFilter">Pincode</label>
                    <input type="text" id="pincodeFilter" class="form-input" placeholder="Enter pincode">
                </div>

                <div class="form-group" style="display: flex; align-items: flex-end;">
                    <button class="btn btn-primary btn-block" id="applyFiltersBtn">Apply Filters</button>
                </div>
            </div>
        </section>

        <!-- Workers Grid -->
        <section class="workers-section mt-lg">
            <div class="grid grid-3 gap-lg" id="workersGrid">
                <!-- Workers will be loaded dynamically -->
            </div>

            <div id="emptyState" class="hidden">
                <div class="empty-state">
                    <div class="empty-state-icon">üë∑</div>
                    <p>No workers found matching your criteria.</p>
                    <button class="btn btn-ghost mt-md" onclick="window.location.reload()">Reset Filters</button>
                </div>
            </div>
        </section>

    </main>

    <style>
        .page-header h1 {
            font-size: 2.5rem;
            margin-bottom: var(--spacing-xs);
        }

        .filters-section {
            padding: var(--spacing-lg);
        }

        .search-bar-wrapper {
            position: relative;
        }

        .search-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.1rem;
            pointer-events: none;
            z-index: 1;
        }

        .search-input {
            padding-left: 44px !important;
            font-size: 1.05rem;
        }

        .mb-md {
            margin-bottom: var(--spacing-md);
        }

        .worker-card {
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .worker-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--color-accent-primary), transparent);
            opacity: 0;
            transition: opacity var(--transition-normal);
        }

        .worker-card:hover {
            border-color: var(--color-accent-primary);
            box-shadow: var(--glow-orange);
            transform: translateY(-4px);
        }

        .worker-card:hover::before {
            opacity: 1;
        }

        .worker-avatar {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            /* background: #ffffff; */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            flex-shrink: 0;
            box-shadow: 0 0 12px rgba(255, 165, 0, 0.3);
        }

        .worker-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: var(--spacing-md);
        }

        .worker-info h3 {
            font-size: 1.5rem;
            color: var(--color-text-primary);
            margin-bottom: var(--spacing-xs);
        }

        .worker-category {
            font-size: 0.9rem;
            color: var(--color-accent-primary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .worker-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--color-success);
            box-shadow: 0 0 10px var(--color-success);
        }

        .status-indicator.busy {
            background: var(--color-error);
            box-shadow: 0 0 10px var(--color-error);
        }

        .worker-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
            padding: var(--spacing-sm) 0;
            border-top: 1px solid var(--color-border);
            border-bottom: 1px solid var(--color-border);
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-family: var(--font-display);
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-accent-primary);
            white-space: nowrap;
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--color-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .worker-details {
            margin-bottom: var(--spacing-md);
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: var(--spacing-xs) 0;
            font-size: 0.9rem;
        }

        .detail-label {
            color: var(--color-text-secondary);
        }

        .detail-value {
            color: var(--color-text-primary);
            font-weight: 600;
        }

        .rating {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .star {
            color: #ffa500;
        }

        .empty-state {
            text-align: center;
            padding: var(--spacing-xxl);
            color: var(--color-text-muted);
        }

        .empty-state-icon {
            font-size: 5rem;
            margin-bottom: var(--spacing-md);
            opacity: 1;
        }

        @media (max-width: 768px) {
            .navbar-nav {
                display: none;
            }

            .worker-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>

    <script type="module">
        import { account, databases, APPWRITE_CONFIG, showLoading, hideLoading, showAlert, logout } from '/js/appwrite.js';
        import { Query } from 'https://cdn.jsdelivr.net/npm/appwrite@14.0.1/+esm';

        let currentUser = null;
        let allWorkers = [];
        let filteredWorkers = [];

        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const selectedCategory = urlParams.get('category');

        // Initialize
        async function init() {
            showLoading('Loading workers...');

            try {
                // Check authentication
                try {
                    currentUser = await account.get();
                } catch (authError) {
                    console.error('Authentication error:', authError);
                    // User not logged in, redirect to login
                    if (authError.code === 401 || authError.message.includes('guests')) {
                        showAlert('Please login to continue', 'error');
                        setTimeout(() => {
                            window.location.href = '/login.html';
                        }, 1500);
                        return;
                    }
                    throw authError;
                }

                // Set category filter if provided
                if (selectedCategory) {
                    document.getElementById('categoryFilter').value = selectedCategory;
                    const categoryNames = {
                        'plumber': 'Plumber',
                        'electrician': 'Electrician',
                        'ac-technician': 'AC Technician',
                        'carpenter': 'Carpenter',
                        'painter': 'Painter',
                        'cleaner': 'Cleaner',
                        'gardener': 'Gardener',
                        'mechanic': 'Mechanic'
                    };
                    document.getElementById('categoryName').textContent = `${categoryNames[selectedCategory]} Services`;
                }

                await loadWorkers();

            } catch (error) {
                console.error('Initialization error:', error);
                showAlert('Failed to load workers. Please try again.', 'error');
            } finally {
                hideLoading();
            }
        }

        // Load workers
        async function loadWorkers() {
            try {
                let workersResponse;

                try {
                    const queries = [
                        Query.equal('isApproved', true),
                        Query.equal('isActive', true)
                    ];

                    if (selectedCategory) {
                        queries.push(Query.equal('skillCategory', selectedCategory));
                    }

                    workersResponse = await databases.listDocuments(
                        APPWRITE_CONFIG.databaseId,
                        APPWRITE_CONFIG.collections.workers,
                        queries
                    );
                } catch (queryError) {
                    // Fallback: fetch all workers and filter client-side
                    console.warn('Worker attributes not indexed, using fallback:', queryError);
                    const allWorkersResponse = await databases.listDocuments(
                        APPWRITE_CONFIG.databaseId,
                        APPWRITE_CONFIG.collections.workers
                    );

                    // Filter client-side
                    const filtered = allWorkersResponse.documents.filter(w => {
                        if (!w.isApproved || !w.isActive) return false;
                        if (selectedCategory && w.skillCategory !== selectedCategory) return false;
                        return true;
                    });

                    workersResponse = { documents: filtered };
                }

                allWorkers = workersResponse.documents;

                // Fetch user data for all workers to get names
                const userIds = [...new Set(allWorkers.map(w => w.userId))];

                if (userIds.length === 0) {
                    filteredWorkers = [];
                    displayWorkers();
                    return;
                }

                // Fetch all users (we'll filter client-side since Query.equal doesn't support arrays)
                const usersResponse = await databases.listDocuments(
                    APPWRITE_CONFIG.databaseId,
                    APPWRITE_CONFIG.collections.users
                );

                // Create a map of userId to name
                const userNameMap = {};
                usersResponse.documents.forEach(user => {
                    if (userIds.includes(user.userId)) {
                        userNameMap[user.userId] = user.name;
                    }
                });

                // Add names to worker objects
                allWorkers.forEach(worker => {
                    worker.name = userNameMap[worker.userId] || 'Worker';
                });

                filteredWorkers = [...allWorkers];

                displayWorkers();

            } catch (error) {
                console.error('Error loading workers:', error);
                showAlert(`Failed to load workers: ${error.message}`, 'error');
            }
        }

        // Display workers
        function displayWorkers() {
            const workersGrid = document.getElementById('workersGrid');
            const emptyState = document.getElementById('emptyState');

            if (filteredWorkers.length === 0) {
                workersGrid.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }

            workersGrid.classList.remove('hidden');
            emptyState.classList.add('hidden');
            workersGrid.innerHTML = '';

            const categoryIcons = {
                'plumber': 'üîß',
                'electrician': '‚ö°',
                'ac-technician': '‚ùÑÔ∏è',
                'carpenter': 'ü™ö',
                'painter': 'üé®',
                'cleaner': 'üßπ',
                'gardener': 'üå±',
                'mechanic': 'üî©'
            };

            filteredWorkers.forEach(worker => {
                const workerCard = document.createElement('div');
                workerCard.className = 'worker-card';

                const rating = worker.rating || 0;
                const stars = '‚≠ê'.repeat(Math.round(rating));
                const avatarIcon = categoryIcons[worker.skillCategory] || 'üë∑';

                workerCard.innerHTML = `
          <div class="worker-header">
            <div class="worker-avatar">${avatarIcon}</div>
            <div>
              <div class="worker-name">${worker.name}</div>
              <div class="worker-category">${worker.skillCategory || 'N/A'}</div>
            </div>
          </div>
          
          <div class="worker-stats">
            <div class="stat-item">
              <div class="stat-label">Experience</div>
              <div class="stat-value">${worker.experience || 0} years</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Completed</div>
              <div class="stat-value">${worker.completedJobs || 0} jobs</div>
            </div>
          </div>
          
          <div class="worker-details">
            <div class="detail-row">
              <span class="detail-label">Service Area:</span>
              <span class="detail-value">${worker.serviceArea ? worker.serviceArea.join(', ') : 'N/A'}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Charges:</span>
              <span class="detail-value">‚Çπ${worker.charges || 0}/hour</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Rating:</span>
              <span class="detail-value rating">${stars} ${rating.toFixed(1)}</span>
            </div>
          </div>
          
          <button class="btn btn-primary btn-block" onclick="bookWorker('${worker.$id}', '${worker.skillCategory}', ${worker.charges})">
            Book Now
          </button>
        `;

                workersGrid.appendChild(workerCard);
            });
        }

        // Apply all filters (search + category + pincode)
        function applyAllFilters() {
            const searchQuery = document.getElementById('searchInput').value.trim().toLowerCase();
            const category = document.getElementById('categoryFilter').value;
            const pincode = document.getElementById('pincodeFilter').value.trim();

            filteredWorkers = (allWorkers || []).filter(worker => {
                if (searchQuery && !(worker.name || '').toLowerCase().includes(searchQuery)) return false;
                if (category && worker.skillCategory !== category) return false;
                if (pincode && (!worker.serviceArea || !worker.serviceArea.includes(pincode))) return false;
                return true;
            });

            displayWorkers();
        }

        // Instant search on typing
        document.getElementById('searchInput').addEventListener('input', applyAllFilters);

        // Apply filters button
        document.getElementById('applyFiltersBtn').addEventListener('click', applyAllFilters);

        // Book worker
        window.bookWorker = function (workerId, category, charges) {
            sessionStorage.setItem('selectedWorker', workerId);
            sessionStorage.setItem('serviceCategory', category);
            sessionStorage.setItem('estimatedPrice', charges);
            window.location.href = '/customer/booking.html';
        };

        // Logout handler
        document.getElementById('logoutBtn').addEventListener('click', logout);

        // Initialize on page load
        init();
    </script>

    <!-- Theme Toggle -->
    <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme">
        <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2">
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
        </svg>
        <svg id="moon-icon" class="hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </svg>
    </button>

    <script type="module">
        import { toggleTheme, initTheme } from '/js/theme.js';
        window.toggleTheme = toggleTheme;
        initTheme();
    </script>

</body>

</html>